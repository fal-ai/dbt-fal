name: Run Integration Tests

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      python_versions:
        required: true
        type: string
      dbt_versions:
        required: true
        type: string
      dbt_adapter:
        required: true
        type: string

      docker_db:
        required: false
        type: boolean
    secrets:
      env_vars:
        required: false
        description: One liner to set adapter environment variables. (e.g. 'HOST=some SCHEMA=other')

jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ${{fromJson(inputs.python_versions)}}
        dbt: ${{fromJson(inputs.dbt_versions)}}

    steps:
      - name: Setup local fal
        uses: fal-ai/fal/.github/actions/setup-local-fal@dry-workflow
        with:
          python: ${{ matrix.python }}
          dbt: ${{ matrix.dbt }}
          adapter: postgres

      - name: Start test Docker database
        working-directory: integration_tests
        if: ${{ inputs.docker_db == 'true' }}
        run: docker-compose up -d

      - name: Setup behave
        run: pip install behave

        # Avoid running against the same profile at the same time
      - name: Set up mutex on profiles
        uses: ben-z/gh-action-mutex@v1.0-alpha-4
        if: ${{ inputs.docker_db != 'true' }}
        with:
          branch: gh-mutex-profile-${{ inputs.dbt_adapter }}

      - name: Run tests
        working-directory: integration_tests
        env:
          FAL_STATS_ENABLED: false
        run: |
          export ${{ secrets.env_vars }}
          if [ ! -z "$KEYFILE" ]
          then
            echo "$KEYFILE" > $HOME/keyfile.json
            export KEYFILE_DIR=$HOME
          fi

          behave --tags=-broken_profile -D profile=${{ inputs.dbt_adapter }}

      - name: Send custom JSON data to Slack workflow
        if: failure()
        id: slack
        uses: slackapi/slack-github-action@v1.18.0
        with:
          # For posting a rich message using Block Kit
          payload: |
            {
              "text": "Integration tests failed for ${{ inputs.dbt_adapter }}, Python version ${{ matrix.python }}. https://github.com/fal-ai/fal/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
